name: Sainsburys Price Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 1'  # Mondays at 10 AM UTC (1 hour after Morrisons)

permissions:
  contents: write

jobs:
  scrape-sainsburys:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for 91 categories
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get clean
        sudo apt-get update --fix-missing
        sudo apt-get install -y --fix-broken wget curl unzip xvfb
        sudo apt-get install -y --no-install-recommends libnss3-dev libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgtk-3-0 libatspi2.0-0
        sudo apt-get install -y libasound2t64 libxrandr2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgdk-pixbuf2.0-0
    
    - name: Install Chrome (stable version)
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Get exact Chrome version
        CHROME_VERSION=$(google-chrome --version)
        echo "Installed Chrome version: $CHROME_VERSION"
    
    - name: Install matching ChromeDriver
      run: |
        # Get Chrome major version
        CHROME_MAJOR=$(google-chrome --version | sed 's/Google Chrome //' | cut -d'.' -f1)
        echo "Chrome major version: $CHROME_MAJOR"
        
        # Always use the Chrome for Testing API for newer versions
        echo "Getting ChromeDriver for Chrome $CHROME_MAJOR"
        LATEST_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE")
        echo "Using ChromeDriver version: $LATEST_VERSION"
        
        # Download and install ChromeDriver
        wget -O /tmp/chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/$LATEST_VERSION/linux64/chromedriver-linux64.zip"
        sudo unzip /tmp/chromedriver.zip -d /tmp/
        sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installation
        chromedriver --version
        echo "ChromeDriver installed successfully"
    
    - name: Install Python dependencies
      run: |
        cd WebScrape
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install undetected-chromedriver --upgrade
        pip install pandas
        
        echo "Installed packages:"
        pip list | grep -E "(selenium|pandas|beautifulsoup|undetected|lxml|requests)"
    
    - name: Enhanced Sainsburys optimization for stealth
      run: |
        cd WebScrape
        echo "Applying enhanced optimizations for Sainsburys..."
        
        # Backup original
        cp sainsburys.py sainsburys.py.backup
        
        # Create enhanced version with better stealth
        cat > enhance_sainsburys.py << 'EOF'
        import re
        
        with open('sainsburys.py', 'r') as f:
            content = f.read()
        
        print("Applying enhanced Sainsburys optimizations...")
        
        # Remove headless mode temporarily for debugging
        content = re.sub(r"options\.add_argument\('--headless'\)", "", content)
        print("‚ùå Removed headless mode for debugging")
        
        # Add better stealth options
        stealth_options = [
            "--disable-blink-features=AutomationControlled",
            "--disable-web-security",
            "--allow-running-insecure-content",
            "--disable-features=VizDisplayCompositor",
            "--disable-ipc-flooding-protection"
        ]
        
        # Find the options setup section
        for option in stealth_options:
            if option not in content:
                content = re.sub(
                    r'(options\.add_argument\(\'--disable-images\'\))',
                    rf'\1\n    options.add_argument(\'{option}\')',
                    content
                )
                print(f"‚úÖ Added {option}")
        
        # Reduce workers to 1 for stability
        content = re.sub(r'max_workers=\d+', 'max_workers=1', content)
        print("‚úÖ Set max_workers=1")
        
        # Add longer waits between requests
        content = re.sub(r'time\.sleep\(0\.3\)', 'time.sleep(2.0)', content)
        content = re.sub(r'time\.sleep\(1\)', 'time.sleep(3.0)', content)
        print("‚úÖ Increased wait times")
        
        # Limit to fewer categories for testing
        content = re.sub(r'max_pages = \d+', 'max_pages = 2', content)
        print("‚úÖ Limited to 2 pages per category for testing")
        
        with open('sainsburys.py', 'w') as f:
            f.write(content)
        
        print("‚úÖ Enhanced Sainsburys scraper for better stealth")
        EOF
        
        python enhance_sainsburys.py
    
    - name: Create public directory
      run: mkdir -p app/public
    
    - name: Run Sainsburys scraper (enhanced stealth mode)
      timeout-minutes: 115
      run: |
        cd WebScrape
        echo "üõí Starting Sainsburys scraper (enhanced stealth)..."
        echo "üìã Categories: 91 categories"
        echo "üë• Workers: 1 (stability)"
        echo "üîí Mode: Non-headless for debugging"
        echo "‚è±Ô∏è Wait times: Increased for stealth"
        echo "üïê Started: $(date)"
        
        # Set display
        export DISPLAY=:99
        
        # Start virtual display with larger resolution
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 10
        
        # Run scraper with enhanced logging
        echo "Executing: python sainsburys.py"
        timeout 6600 python sainsburys.py 2>&1 | tee sainsburys.log
        
        echo "Completed: $(date)"
    
    - name: Debug and check results
      id: results
      run: |
        cd WebScrape
        
        echo "=== DEBUGGING SAINSBURYS SCRAPER ==="
        echo "Checking results..."
        ls -la *.csv 2>/dev/null || echo "No CSV files found"
        
        echo ""
        echo "=== LOG ANALYSIS ==="
        if [ -f "sainsburys.log" ]; then
          echo "üìã Checking for common issues:"
          
          # Check for detection issues
          if grep -q "detected" sainsburys.log; then
            echo "‚ö†Ô∏è Bot detection found in logs"
          fi
          
          # Check for timeout issues
          if grep -q "timeout" sainsburys.log; then
            echo "‚ö†Ô∏è Timeout issues found"
          fi
          
          # Check for network issues
          if grep -q "network" sainsburys.log; then
            echo "‚ö†Ô∏è Network issues found"
          fi
          
          # Show category attempts
          echo ""
          echo "üìä Categories attempted:"
          grep "Starting:" sainsburys.log | head -10
          
          echo ""
          echo "üìä Product counts per category:"
          grep "No products found\|products found" sainsburys.log | head -10
        fi
        
        if [ -f "sainsburys.csv" ]; then
          echo "‚úÖ Found sainsburys.csv"
          
          # Copy to public directory
          cp sainsburys.csv ../app/public/
          
          # Get stats
          total_lines=$(wc -l < sainsburys.csv)
          product_count=$((total_lines - 1))
          file_size=$(ls -lh sainsburys.csv | awk '{print $5}')
          
          echo "üìä Results:"
          echo "- Products: $product_count"
          echo "- File size: $file_size"
          
          # Set outputs
          echo "success=true" >> $GITHUB_OUTPUT
          echo "product_count=$product_count" >> $GITHUB_OUTPUT
          
          # Show sample if products found
          if [ "$product_count" -gt 0 ]; then
            echo "üìã Sample products:"
            head -6 sainsburys.csv | tail -5
          fi
          
        else
          echo "‚ùå No sainsburys.csv found"
          echo ""
          echo "üìã Last 50 lines of log:"
          tail -50 sainsburys.log 2>/dev/null || echo "No log file"
          
          echo "success=false" >> $GITHUB_OUTPUT
          echo "product_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload comprehensive logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sainsburys-debug-logs
        path: |
          WebScrape/sainsburys.log
          WebScrape/sainsburys.py.backup
          WebScrape/sainsburys.py
        retention-days: 14
        if-no-files-found: ignore
    
    - name: Commit changes if successful
      if: steps.results.outputs.success == 'true' && steps.results.outputs.product_count != '0'
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions - Sainsburys"
        
        git add -f app/public/sainsburys.csv
        
        if ! git diff --staged --quiet; then
          git commit -m "üõí Sainsburys price update - $(date -u '+%Y-%m-%d %H:%M UTC')

          Products: ${{ steps.results.outputs.product_count }}
          Store: Sainsburys (enhanced stealth mode)
          
          Auto-updated via GitHub Actions"
          
          git push origin HEAD:${{ github.ref_name }}
          echo "‚úÖ Changes pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "## üõí Sainsburys Scraper Debug Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.results.outputs.success }}" == "true" ] && [ "${{ steps.results.outputs.product_count }}" != "0" ]; then
          echo "### ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Products:** ${{ steps.results.outputs.product_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** Enhanced stealth (non-headless)" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Failed or No Products Found" >> $GITHUB_STEP_SUMMARY
          echo "- **Products found:** ${{ steps.results.outputs.product_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue:** Likely detection or website structure change" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** Non-headless debugging enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** Check uploaded debug logs" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîß Debug Features Enabled" >> $GITHUB_STEP_SUMMARY
        echo "- **Headless:** Disabled for debugging" >> $GITHUB_STEP_SUMMARY
        echo "- **Enhanced stealth:** Anti-detection features" >> $GITHUB_STEP_SUMMARY
        echo "- **Slower execution:** Longer waits between requests" >> $GITHUB_STEP_SUMMARY
        echo "- **Limited pages:** 2 pages per category for testing" >> $GITHUB_STEP_SUMMARY
        echo "- **Comprehensive logging:** Full debug logs uploaded" >> $GITHUB_STEP_SUMMARY